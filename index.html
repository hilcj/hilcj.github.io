<!doctype html>
<html lang="en">
  <head>
    <title>一个正经的豆瓣打分数据分析</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link href="https://fonts.googleapis.com/css?family=Rubik:300,400,500" rel="stylesheet">

    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/animate.css">
    <link rel="stylesheet" href="css/owl.carousel.min.css">

    <link rel="stylesheet" href="fonts/ionicons/css/ionicons.min.css">
    <link rel="stylesheet" href="fonts/fontawesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css">
    <link rel="stylesheet" href="css/magnific-popup.css">

    <!-- Theme Style -->
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    
    <header role="banner">

    </header>
    <!-- END header -->

    <!-- END section -->
    <section class="site-section element-animate">
      <div class="container">
        <div class="row align-items-center">
          <div class="col-md-6 order-md-1">
            <div class="block-16 block-15">
              <div class="heading">
                <h2>豆瓣打分数据分析</h2>
              </div>

              <div class="row">
                <div class="col-md-6">
                  <div class="row heading">
                    <h3>选择分类</h3>
                  </div>

                  <div class="row">
                  <div class="col-md-6" style="padding: 10px">
                  <div class="d-flex align-items-center">
                  <select id="genres" size = 10 class="lst">
                    <option value="全部">全部</option>
                    <option value="剧情">剧情</option>
                    <option value="喜剧">喜剧</option>
                    <option value="动作">动作</option>
                    <option value="爱情">爱情</option>
                    <option value="惊悚">惊悚</option>
                    <option value="犯罪">犯罪</option>
                    <option value="恐怖">恐怖</option>
                    <option value="动画">动画</option>
                    <option value="科幻" selected>科幻</option>
                    <option value="冒险">冒险</option>
                    <option value="悬疑">悬疑</option>
                    <option value="短片">短片</option>
                    <option value="奇幻">奇幻</option>
                    <option value="家庭">家庭</option>
                    <option value="战争">战争</option>
                    <option value="传记">传记</option>
                    <option value="历史">历史</option>
                    <option value="纪录片">纪录片</option>
                    <option value="同性">同性</option>
                    <option value="歌舞">歌舞</option>
                    <option value="音乐">音乐</option>
                    <option value="情色">情色</option>
                    <option value="古装">古装</option>
                    <option value="武侠">武侠</option>
                    <option value="运动">运动</option>
                    <option value="西部">西部</option>
                    <option value="儿童">儿童</option>
                    <option value="黑色电影">黑色电影</option>
                    <option value="灾难">灾难</option>
                    <option value="舞台艺术">舞台艺术</option>
                    <option value="真人秀">真人秀</option>
                    <option value="戏曲">戏曲</option>
                    <option value="鬼怪">鬼怪</option>
                    <option value="Adult">Adult</option>
                    <option value="脱口秀">脱口秀</option>
                    <option value="惊栗">惊栗</option>
                    <option value="荒诞">荒诞</option>
                    <option value="Reality-TV">Reality-TV</option>
                    <option value="悬念">悬念</option>
                    <option value="動畫 Animation">動畫 Animation</option>
                  </select>
                  </div>
                  </div>

                  <div class="col-md-6" style="padding: 10px">
                  <div class="align-items-center">
                  <select id=rating size=10 class="lst">
                    <option value="0">前10%，8.3~9.8分</option>
                    <option value="1" selected>前10%~前20%，7.9~8.3分</option>
                    <option value="2">前20%~前30%，7.6~7.9分</option>
                    <option value="3">前30%~前40%，7.4~7.6分</option>
                    <option value="4">前40%~前50%，7.1~7.4分</option>
                    <option value="5">后40%~后50%，6.7~7.1分</option>
                    <option value="6">后30%~后40%，6.4~6.7分</option>
                    <option value="7">后20%~后30%，5.9~6.4分</option>
                    <option value="8">后10%~后20%，5.1~5.9分</option>
                    <option value="9">后10%，2.1~5.1分</option>
                  </select>
                  </div>
                  </div>
                </div>
                </div>
              </div>

              <!-- <div class="row"> -->
                <div class="row heading">
                  <h3>自定义数据点</h3>&nbsp&nbsp&nbsp
                  <label class="container-ckbx">显示自定义数据点
                    <input type="checkbox" checked id="show_customize_data">
                    <span class="checkmark"></span>
                  </label>
                </div>

                <div class="row">

                </div>

                <div class="row" style="padding: 10px">
                  影片标题<input type="text" class="txtbox" style="width:60%" value="流浪地球" id="custome_title"><br>
                </div>
                <div class="row">
                  5星<input type="range" class="slider" min="0" max="100" value="31.1" id="r5">
                  <input type="text" class="txtbox" style="width:15%" value="31.1" id="r5t">%
                </div>
                <div class="row">
                  4星<input type="range" class="slider" min="0" max="100" value="39.9" id="r4">
                  <input type="text" class="txtbox" style="width:15%" value="39.9" id="r4t">%
                </div>
                <div class="row">
                  3星<input type="range" class="slider" min="0" max="100" value="22.3" id="r3">
                  <input type="text" class="txtbox" style="width:15%" value="22.3" id="r3t">%
                </div>
                <div class="row">
                  2星<input type="range" class="slider" min="0" max="100" value="4.6" id="r2">
                  <input type="text" class="txtbox" style="width:15%" value="4.6" id="r2t">%
                </div>
                <div class="row">
                  1星<input type="range" class="slider" min="0" max="100" value="2.1" id="r1">
                  <input type="text" class="txtbox" style="width:15%" value="2.1" id="r1t">%
                </div>
              </div>
            <!-- </div> -->
          </div>
          <div class="col-md-6 order-md-2">
            <div class="block-15">
              <figure>
                <canvas id="rating_chart" width="100%" height="100%"></canvas>
              </figure>
            </div>
            <div class="block-15" align="center">
                误差线P=0.95
            </div>
            <div class="block-15" align="center">
                <a href="#recommend_div" class="btn btn-primary reverse py-2 px-4">vvv向下查看一些此分类下的电影vvv</a></p>
            </div>
          </div>
        </div>
      </div>
    </section>


    <div class="site-section bg-light" id=recommend_div>
      <div class="container">
        <div class="row justify-content-center mb-5 element-animate">
          <!-- <div class="col-md-6 order-md-1"> -->
            <div class="col-md-7 text-center section-heading">
              <h2 class="text-primary heading">选定内别中最热电影</h2>
              <div id=recommend></div>
            </div>
          <!-- </div> -->
        </div>
      </div>
    </div>
    <!-- END section -->


    <footer class="site-footer">
      <div class="container">
        <div class="row mb-5">
          <div class="mb-5">
            <h3>作者信息</h3>
            欢迎关注知乎 <a href="https://www.zhihu.com/people/happyhtml/activities">我的知乎</a><br>
            github源码：<a href="https://github.com/hilcj/douban_data_stat">https://github.com/hilcj/douban_data_stat</a> <br>
            数据下载：<a href='./database.js'>database.js</a>
          </div>
          <div class="mb-5">
            <h3>引用</h3>
              豆瓣电影数据：douban.com<br>
              网站模板：https://colorlib.com/wp/template/university/<br>
          </div>
        </div>
      </div>
    </footer>
    <!-- END footer -->
    
    <!-- loader -->
    <div id="loader" class="show fullscreen"><svg class="circular" width="48px" height="48px"><circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/><circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#f4b214"/></svg></div>

    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/jquery-migrate-3.0.0.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.stellar.min.js"></script>
    <script src="js/jquery.animateNumber.min.js"></script>
    
    <script src="js/jquery.magnific-popup.min.js"></script>

    <script src="js/main.js"></script>


<script src="Chart.min.js"></script>
<script src="Plugin.Errorbars.min.js"></script>
<script src="database.js"></script>
<script>
Chart.defaults.global.defaultFontSize = 17;
var ctx = document.getElementById("rating_chart").getContext("2d");
var rating_data = {
  labels: ["5星", "4星", "3星", "2星", "1星"],
  datasets: []
};
var title="Demo";
var rating_chart_js = new Chart(ctx, {
  type: "horizontalBar",
  data: rating_data,
  options: {
    title: {
      display: true,
      text: title,
      fontSize: 23,
    },
    scales: {
      xAxes: [{
        stacked: false,
      }],
      yAxes: [{
        ticks: {
          beginAtZero:true
        }
      }]
    },
    plugins: {
      chartJsPluginBarchartBackground: {
        color: '#eeeeee'
      }, chartJsPluginErrorBars: {
        //color: '#666'
        width: '60%'
      }
    }
  }
});
</script>

<script type="text/javascript">
  function UpdatePlot(){
    rating_chart_js.titleBlock.options.text = 
    "类型: " + document.getElementById("genres").value + "；分数区间：" +
    document.getElementById("rating")[parseInt(document.getElementById("rating").value)].text + "。";

    rating_data.datasets = [];
    var genres = document.getElementById("genres").value;
    var rating_id = document.getElementById("rating").value;
    var data = database[genres][rating_id];
    if (Array.isArray(data) & data.length == 0) {
      rating_chart_js.titleBlock.options.text += "（无数据）";
    } else {
      var v5 = parseInt(data["rating"][5] * 1000) / 10;
      var v4 = parseInt(data["rating"][4] * 1000) / 10;
      var v3 = parseInt(data["rating"][3] * 1000) / 10;
      var v2 = parseInt(data["rating"][2] * 1000) / 10;
      var v1 = parseInt(data["rating"][1] * 1000) / 10;
      var v5sd = parseInt(2 * data["rating"]["5sd"] * 1000) / 10;
      var v4sd = parseInt(2 * data["rating"]["4sd"] * 1000) / 10;
      var v3sd = parseInt(2 * data["rating"]["3sd"] * 1000) / 10;
      var v2sd = parseInt(2 * data["rating"]["2sd"] * 1000) / 10;
      var v1sd = parseInt(2 * data["rating"]["1sd"] * 1000) / 10;
      rating_data.datasets.push({
        label: "平均水平（基于" + parseInt(data["rating"]["#films"]) + "部电影，" + parseInt(data["rating"]["count"]) + "次评分）",
        data: [v5, v4, v3, v2, v1],
        errorBars: {"5星": {plus: Math.min(100 - v5, v5sd), minus: -Math.min(v5, v5sd)},
                    "4星": {plus: Math.min(100 - v4, v4sd), minus: -Math.min(v4, v4sd)},
                    "3星": {plus: Math.min(100 - v3, v3sd), minus: -Math.min(v3, v3sd)},
                    "2星": {plus: Math.min(100 - v2, v2sd), minus: -Math.min(v2, v2sd)},
                    "1星": {plus: Math.min(100 - v1, v1sd), minus: -Math.min(v1, v1sd)}},
        backgroundColor: "rgba(255, 206, 86, 0.2)",
        borderColor: "rgba(255, 206, 86, 1)",
        borderWidth: 1
      });
      document.getElementById("recommend").innerHTML = "";
      for(var i = 0; i < data["top_films"].length; i++) {
        var url = "https://movie.douban.com/subject/" + data["top_films"][i]["film_id"];
        var text = data["top_films"][i]["title"] + "，" + 
                   data["top_films"][i]["rating_average"] + "分，<a href=" + url + ">" + url + "</a>";
        document.getElementById("recommend").innerHTML += text + "<br>";
      }
    }
    if (document.getElementById("show_customize_data").checked) {
      rating_data.datasets.push({
        label: document.getElementById("custome_title").value,
        data: [document.getElementById("r5t").value,
               document.getElementById("r4t").value,
               document.getElementById("r3t").value,
               document.getElementById("r2t").value,
               document.getElementById("r1t").value],
        backgroundColor: "rgba(123, 206, 255, 0.2)",
        borderColor: "rgba(123, 206, 200, 1)",
        borderWidth: 1
      });
    }
    rating_chart_js.update();
  }
</script>

<script type="text/javascript">
  document.getElementById("genres").addEventListener("change", function() {
    UpdatePlot();
  });
  document.getElementById("rating").addEventListener("change", function() {
    UpdatePlot();
  });
  document.getElementById("show_customize_data").addEventListener("change", function() {
    UpdatePlot()
  });
  UpdatePlot();
</script>

<script type="text/javascript">
  document.getElementById("r5").addEventListener("change", function() {
    document.getElementById("r5t").value = document.getElementById("r5").value;
    UpdatePlot()
  });
  document.getElementById("r5t").addEventListener("change", function() {
    var val = parseFloat(document.getElementById("r5t").value);
    if(val > 100) {
      val = 100;
    } else if (val < 0) {
      val = 0;
    }
    document.getElementById("r5t").value = val;
    document.getElementById("r5").value = val;
    UpdatePlot()
  });
  document.getElementById("r4").addEventListener("change", function() {
    document.getElementById("r4t").value = document.getElementById("r4").value;
    UpdatePlot()
  });
  document.getElementById("r4t").addEventListener("change", function() {
    var val = parseFloat(document.getElementById("r4t").value);
    if(val > 100) {
      val = 100;
    } else if (val < 0) {
      val = 0;
    }
    document.getElementById("r4t").value = val;
    document.getElementById("r4").value = val;
    UpdatePlot()
  });
  document.getElementById("r3").addEventListener("change", function() {
    document.getElementById("r3t").value = document.getElementById("r3").value;
    UpdatePlot()
  });
  document.getElementById("r3t").addEventListener("change", function() {
    var val = parseFloat(document.getElementById("r3t").value);
    if(val > 100) {
      val = 100;
    } else if (val < 0) {
      val = 0;
    }
    document.getElementById("r3t").value = val;
    document.getElementById("r3").value = val;
    UpdatePlot()
  });
  document.getElementById("r2").addEventListener("change", function() {
    document.getElementById("r2t").value = document.getElementById("r2").value;
    UpdatePlot()
  });
  document.getElementById("r2t").addEventListener("change", function() {
    var val = parseFloat(document.getElementById("r2t").value);
    if(val > 100) {
      val = 100;
    } else if (val < 0) {
      val = 0;
    }
    document.getElementById("r2t").value = val;
    document.getElementById("r2").value = val;
    UpdatePlot()
  });
  document.getElementById("r1").addEventListener("change", function() {
    document.getElementById("r1t").value = document.getElementById("r1").value;
    UpdatePlot()
  });
  document.getElementById("r1t").addEventListener("change", function() {
    var val = parseFloat(document.getElementById("r1t").value);
    if(val > 100) {
      val = 100;
    } else if (val < 0) {
      val = 0;
    }
    document.getElementById("r1t").value = val;
    document.getElementById("r1").value = val;
    UpdatePlot()
  });
</script>
  </body>
</html>